library(tidyverse)
library(tximport)
library(readr)
library(DESeq2)

dbxdir='~/Dropbox/yfan/dunlop/rna'

datadir='/dilithium/Data/NGS/projects/dunlop_rna/deter_data'
saldir=file.path(datadir, 'salmon')
allpaths=list.dirs(saldir, recursive=FALSE)
conditions=factor(rep(c('control', 'fresh', 'amp'), each=3))


sampinfo=data.frame(condition=conditions, paths=allpaths)
rownames(sampinfo)=basename(allsamps)

quantfiles=file.path(allpaths, 'quant.sf')
txi=tximport(quantfiles, type='salmon', txOut=T)
dds=DESeqDataSetFromTximport(txi, colData=sampinfo, design= ~ condition)


##prefiltering
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]


dds <- DESeq(dds)
res <- results(dds)

nares=res[!is.na(res$pvalue),]
pres=nares[nares$pvalue<.05,]
presOrdered=pres[order(pres$log2FoldChange),]

plotfile=file.path(dbxdir, 'test.pdf')
pdf(plotfile)
plotMA(res)
dev.off()